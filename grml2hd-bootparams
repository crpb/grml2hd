#!/bin/sh
# Filename:      grml2hd-bootparams
# Purpose:       prompt for bootparams which should be use for the grml system
# Authors:       grml-team (grml.org), (c) Michael Prokop <mika(at)grml.org>
# Bug-Reports:   see http://grml.org/bugs/
# License:       This file is licensed under the GPL v2.
################################################################################

LANG=C
LC_ALL=C
PN=$(basename "$0")
TMPFILE=$(mktemp)
CMDLINE="$(cat /proc/cmdline)"

# same for strings
stringinstring(){
  case "$2" in *$1*) return 0;; esac
  return 1
}

# Reread boot command line; echo last parameter's argument or return false.
getbootparam(){
  stringinstring " $1=" "$CMDLINE" || return 1
  result="${CMDLINE##*$1=}"
  result="${result%%[ 	]*}"
  echo "$result"
  return 0
}

# Check boot commandline for specified option
checkbootparam(){
  stringinstring " $1" "$CMDLINE"
  return "$?"
}

if checkbootparam "brltty" ; then
  BRLTTY_OPTS="=$(getbootparam brltty)"
fi

if checkbootparam "speakup_synth" ; then
  SPEAKUP_OPTS="=$(getbootparam speakup_synth)"
fi

if checkbootparam "resume" ; then
  RESUME_OPTS="=$(getbootparam resume)"
fi

# helper functions
get_value()
{
  grep -q $* /proc/cmdline && return 0 || return 1
}

get_value "noapic"             && NOAPIC="on"     || NOAPIC="off"
get_value "acpi=force"         && ACPI_FORCE="on" || ACPI_FORCE="off"
get_value "nolapic"            && NOLAPIC="on"    || NOLAPIC="off"
get_value "lapic"              && LAPIC="on"      || LAPIC="off"
get_value "acpi=off"           && ACPI_OFF="on"   || ACPI_OFF="off"
get_value "acpi=noirq"         && ACPI_NOIRQ="on" || ACPI_NOIRQ="off"
get_value "noirqbalance"       && NOIRQ="on"      || NOIRQ="off"
get_value "nopcmcia"           && NOPCMIA="on"    || NOPCMIA="off"
get_value "nodma"              && NODMA="on"      || NODMA="off"
get_value "pci=noacpi"         && PCINOACPI="on"  || PCINOACPI="off"
get_value "pci=biosirq"        && PCIBIOS="on"    || PCIBIOS="off"
get_value "pci=assign-busses"  && PCIASSIGN="on"  || PCIASSIGN="off"
get_value "irqpoll"            && IRQPOLL="on"    || IRQPOLL="off"
get_value "resume"             && RESUME="on"     || RESUME="off"
get_value "brltty"             && BRLTTY="on"     || BRLTTY="off"
get_value "speakup_synth"      && SPEAKUP="on"    || SPEAKUP="off"
get_value "swspeak"            && SWSPEAK="on"    || SWSPEAK="off"

# main program
interface()
{
  dialog --cr-wrap --clear --title "$PN" --checklist "Do you want to use any special boot parameters?

This script checks for the boot parameters you used for booting
the grml system. If there were any important options found
they will be activated in this menu.

If you do not know what to do at this stage just continue!

If you want to adjust boot parameters manually please edit the
append-line in /etc/lilo.conf if you are using lilo or
/boot/grub/menu.lst when using grub. See
/usr/share/doc/kernel-doc-`uname -r`/Documentation/kernel-parameters.txt.gz
for details about kernel parameters.

Set the boot parameters for kernel via bootmanager (lilo/grub):
" 0 0 0 \
  noapic 'disable buggy APIC interrupt routing' $NOAPIC \
  acpi=force 'force usage of ACPI' $ACPI_FORCE \
  nolapic 'disable buggy APIC interrupt routing' $NOLAPIC \
  lapic 'enable the local APIC even if BIOS disabled it' $LAPIC \
  acpi=off 'completely disable ACPI' $ACPI_OFF \
  acpi=noirq 'disable PCI IRQ routing of ACPI' $ACPI_NOIRQ \
  noirqbalance 'disable kernel irq balancing' $NOIRQ \
  nopcmcia 'avoid startup of PCMCIA services' $NOPCMIA \
  nodma 'disable Direct Memory Access' $NODMA \
  pci=noacpi 'disable ACPI for PCI maps' $PCINOACPI \
  pci=biosirq 'use PCI BIOS calls to get interrupt routing table' $PCIBIOS \
  pci=assign-busses 'assign all PCI bus numbers ourselves' $PCIASSIGN \
  irqpoll 'when an interrupt is not handled search in all handlers' $IRQPOLL \
  resume$RESUME_OPTS 'specify swap partition to resume from' $RESUME \
  brltty$BRLTTY_OPTS 'start Braille-Terminal (no X)' $BRLTTY \
  speakup_synth$SPEAKUP_OPTS 'use speakup kernel module with given hardware type' $SPEAKUP \
  swspeak 'use software synthesizer through speakup' $SWSPEAK \
  2>$TMPFILE
}

# and now run it:
  interface
  cat $TMPFILE | sed 's/"//g' > /tmp/bootappendline
  rm -f $TMPFILE &>/dev/null

## END OF FILE #################################################################
